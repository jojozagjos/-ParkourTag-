var Ae=Object.defineProperty;var ke=(e,t,s)=>t in e?Ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var K=(e,t,s)=>ke(e,typeof t!="symbol"?t+"":t,s);import{r as c,j as n,d as Ye,e as Ie}from"./vendor_react-rmNVD0Vg.js";import{l as Ce}from"./vendor-CYkYvWcu.js";import{T as J,R as q,M as U,a as Te,B as Oe,u as Fe,C as Be,b as Ge,c as Ne}from"./vendor_three-DjgEZmuI.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function s(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(r){if(r.ep)return;r.ep=!0;const i=s(r);fetch(r.href,i)}})();function He({socket:e}){const[t,s]=c.useState("Runner"),[a,r]=c.useState("");function i(){e.emit("room:create",{name:t})}function l(){a&&e.emit("room:join",{code:a.toUpperCase(),name:t})}return n.jsx("div",{style:{display:"grid",placeItems:"center",height:"100%"},children:n.jsxs("div",{className:"panel",children:[n.jsx("h1",{style:{marginTop:0},children:"Parkour Tag"}),n.jsx("label",{style:{display:"block",marginBottom:8},children:"Display name"}),n.jsx("input",{value:t,onChange:d=>s(d.target.value),placeholder:"Your name",style:{width:"100%",marginBottom:12}}),n.jsxs("div",{style:{display:"flex",gap:8},children:[n.jsx("button",{onClick:i,children:"Host"}),n.jsx("input",{value:a,onChange:d=>r(d.target.value),placeholder:"Room code",style:{flex:1}}),n.jsx("button",{onClick:l,children:"Join"})]}),n.jsx("p",{style:{opacity:.85,marginTop:12},children:"Host creates a room. Others enter the code to join."})]})})}function De({socket:e,roomCode:t,players:s,selfId:a}){const r=s.find(m=>m.id===a),i=r==null?void 0:r.host;function l(){e.emit("lobby:ready",{ready:!(r!=null&&r.ready)})}function d(){e.emit("game:start")}return n.jsxs("div",{style:{padding:24},children:[n.jsxs("h2",{children:["Room ",t]}),n.jsxs("div",{style:{display:"flex",gap:24,alignItems:"flex-start"},children:[n.jsxs("div",{children:[n.jsx("h3",{children:"Players"}),n.jsx("ul",{children:s.map(m=>n.jsxs("li",{children:[m.name," ",m.host?"(host)":""," ",m.ready?"✅":"⏳"," ",m.id===a?"← you":""]},m.id))})]}),n.jsxs("div",{style:{display:"flex",gap:12},children:[n.jsx("button",{onClick:l,children:r!=null&&r.ready?"Unready":"Ready"}),i&&n.jsx("button",{onClick:d,children:"Start"})]})]}),n.jsx("p",{style:{marginTop:16},children:"All players ready up. Host can start."}),n.jsx("p",{style:{opacity:.8},children:"Map voting will appear during intermission."})]})}function We(e){const t=c.useRef({forward:!1,back:!1,left:!1,right:!1,jump:!1,sprint:!1,crouch:!1,yaw:0,pitch:0}),s=.0025,a=Math.PI/2*.95;return c.useEffect(()=>{const r=(u,o)=>{if(!u.repeat){switch(u.code){case"KeyW":case"ArrowUp":t.current.forward=o;break;case"KeyS":case"ArrowDown":t.current.back=o;break;case"KeyA":case"ArrowLeft":t.current.left=o;break;case"KeyD":case"ArrowRight":t.current.right=o;break;case"Space":t.current.jump=o;break;case"ShiftLeft":case"ShiftRight":t.current.sprint=o;break;case"ControlLeft":case"ControlRight":t.current.crouch=o;break;default:return}e.emit("input",{...t.current})}},i=u=>{document.pointerLockElement===document.body&&(t.current.yaw-=u.movementX*s,t.current.pitch-=u.movementY*s,t.current.pitch>a&&(t.current.pitch=a),t.current.pitch<-a&&(t.current.pitch=-a),e.emit("input",{...t.current}))},l=()=>{var u;if(!document.pointerLockElement){const o=document.body;(u=o.requestPointerLock)==null||u.call(o)}},d=u=>r(u,!0),m=u=>r(u,!1);return window.addEventListener("keydown",d),window.addEventListener("keyup",m),window.addEventListener("mousemove",i),window.addEventListener("click",l),()=>{window.removeEventListener("keydown",d),window.removeEventListener("keyup",m),window.removeEventListener("mousemove",i),window.removeEventListener("click",l)}},[e]),t}const Q="ParkourYard",ee=[{min:[-30,-.5,-30],max:[30,0,30]},{min:[-10,1.5,-10],max:[-3,2,4]},{min:[3,1.2,-6],max:[12,1.9,6]},{min:[-14,3,8],max:[-2,3.5,20]},{min:[6,3.2,10],max:[16,3.8,22]},{min:[-20,0,-18],max:[-18,6,18]},{min:[18,0,-18],max:[20,6,18]},{min:[-2,.8,-2],max:[2,1.6,2]},{min:[-6,1.4,6],max:[-3,2.4,9]},{min:[4,2,-12],max:[9,3,-8]},{min:[-15,.5,-5],max:[-11,1,5]},{min:[-15,1,-5],max:[-12,1.5,5]},{min:[-15,1.5,-5],max:[-13,2,5]},{min:[-25,.5,25],max:[-10,2.5,28]},{min:[10,.5,-28],max:[25,2.5,-25]}],te=[[-8,2.2,0],[8,2.2,0],[0,2.2,-8],[0,2.2,8],[-12,2.6,12],[12,2.6,-12]],Ke={name:Q,aabbs:ee,spawnPoints:te},qe=Object.freeze(Object.defineProperty({__proto__:null,aabbs:ee,default:Ke,name:Q,spawnPoints:te},Symbol.toStringTag,{value:"Module"})),ne="Rooftops",se=[{min:[-40,-.5,-40],max:[40,0,40]},{min:[-15,3,-10],max:[15,3.5,10]},{min:[-30,6,-5],max:[-10,6.5,5]},{min:[10,6.5,-8],max:[30,7,8]},{min:[-5,1.8,-20],max:[5,2.3,-8]},{min:[-22,9,-2],max:[-8,9.3,12]},{min:[8,9.5,-12],max:[24,9.9,2]},{min:[-40,.5,36],max:[40,1.5,38]},{min:[-38,.5,-38],max:[-20,1.5,-36]}],oe=[[-12,3.8,-2],[12,3.8,2],[-24,6.8,0],[24,6.9,0],[-2,2.2,-14],[2,2.2,-14]],Ue={name:ne,aabbs:se,spawnPoints:oe},Xe=Object.freeze(Object.defineProperty({__proto__:null,aabbs:se,default:Ue,name:ne,spawnPoints:oe},Symbol.toStringTag,{value:"Module"})),re=["ParkourYard","Rooftops"],ze={default:"ParkourYard",options:re},Ve=Object.freeze(Object.defineProperty({__proto__:null,default:ze,options:re},Symbol.toStringTag,{value:"Module"})),Ze={default:"ParkourYard"},_={},X=Object.assign({"../../shared/maps/ParkourYard.json":qe,"../../shared/maps/Rooftops.json":Xe,"../../shared/maps/index.json":Ve});for(const e of Object.keys(X)){const t=e.split("/").pop().replace(".json","");_[t]=X[e]}const $e=_[Ze.default]||_[Object.keys(_)[0]];function Je(){const e=new J,t=c.useMemo(()=>{const i=e.load("/assets/textures/floor_grid.png");return i.wrapS=i.wrapT=q,i.repeat.set(10,10),i},[]),s=c.useMemo(()=>{const i=e.load("/assets/textures/wall_noise.png");return i.wrapS=i.wrapT=q,i.repeat.set(4,4),i},[]),a=c.useMemo(()=>new U({map:t}),[t]),r=c.useMemo(()=>new U({map:s}),[s]);return n.jsx("group",{children:$e.aabbs.map((i,l)=>{const d=[i.max[0]-i.min[0],i.max[1]-i.min[1],i.max[2]-i.min[2]],m=[(i.min[0]+i.max[0])/2,(i.min[1]+i.max[1])/2,(i.min[2]+i.max[2])/2],u=l===0?a:r;return n.jsxs("mesh",{position:m,castShadow:!0,receiveShadow:!0,children:[n.jsx("boxGeometry",{args:d}),n.jsx("primitive",{object:u,attach:"material"})]},l)})})}function Qe({scores:e,itId:t}){const s=Object.entries(e).sort((a,r)=>r[1]-a[1]);return n.jsxs("div",{style:{position:"fixed",top:12,right:12,background:"rgba(0,0,0,0.35)",padding:"8px 12px",borderRadius:8,minWidth:160},children:[n.jsx("div",{style:{opacity:.8,marginBottom:6},children:"Scoreboard"}),s.map(([a,r])=>n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:12},children:[n.jsxs("span",{children:[a===t?"IT":"P",":",a.slice(0,4)]}),n.jsx("span",{children:Math.round(r)})]},a))]})}function et({results:e}){return e?n.jsx("div",{style:{position:"fixed",inset:0,display:"grid",placeItems:"center",background:"rgba(0,0,0,0.5)"},children:n.jsxs("div",{style:{background:"#0b1128",padding:24,borderRadius:12,width:360},children:[n.jsx("h3",{style:{marginTop:0},children:"Round Results"}),n.jsx("ol",{children:e.placement.map(t=>n.jsxs("li",{style:{display:"flex",justifyContent:"space-between"},children:[n.jsx("span",{children:t.name}),n.jsx("span",{children:t.score})]},t.id))}),n.jsx("p",{style:{opacity:.8},children:"Intermission. Next map loading soon."})]})}):null}function tt({socket:e,maps:t,current:s}){const a=c.useMemo(()=>t,[t]);return a!=null&&a.length?n.jsxs("div",{style:{position:"fixed",bottom:12,left:"50%",transform:"translateX(-50%)",background:"rgba(0,0,0,0.35)",padding:"10px 12px",borderRadius:10,display:"flex",gap:10},children:[n.jsx("span",{style:{opacity:.8,marginRight:6},children:"Vote next map:"}),a.map(r=>n.jsx("button",{onClick:()=>e.emit("vote:map",{name:r}),style:{padding:"8px 10px",borderRadius:8,border:"1px solid #30407a",background:r===s?"#1b2a5a":"#0d1430",color:"#fff"},children:r},r))]}):null}const nt=70;function I(e,t,s){return e+(t-e)*s}function z(e,t,s){let a=t-e;for(;a>Math.PI;)a-=Math.PI*2;for(;a<-Math.PI;)a+=Math.PI*2;return e+a*s}class st{constructor(){K(this,"buf",[])}push(t){this.buf.push({t:performance.now(),snap:t}),this.buf.length>20&&this.buf.shift()}sample(){var u;if(this.buf.length<2)return((u=this.buf[this.buf.length-1])==null?void 0:u.snap)||null;const t=performance.now()-nt;let s=0;for(;s+1<this.buf.length&&this.buf[s+1].t<t;)s++;const a=this.buf[s],r=this.buf[s+1]||a,i=Math.max(1,r.t-a.t),l=Math.min(1,Math.max(0,(t-a.t)/i));function d(o,f){return[I(o[0],f[0],l),I(o[1],f[1],l),I(o[2],f[2],l)]}const m=[];for(const o of a.snap.players){const f=r.snap.players.find(x=>x.id===o.id)||o;m.push({...o,pos:d(o.pos,f.pos),vel:d(o.vel,f.vel),yaw:z(o.yaw,f.yaw,l),pitch:z(o.pitch,f.pitch,l),mode:f.mode})}return{...r.snap,players:m}}}function ot(e,t,s=1,a=220){e.style.setProperty(t,String(s));const r=performance.now();function i(){const l=performance.now()-r,d=Math.max(0,1-l/a);e.style.setProperty(t,String(d*s)),d>0&&requestAnimationFrame(i)}requestAnimationFrame(i)}const rt={jump:"/assets/sfx/jump.wav",slide:"/assets/sfx/slide.wav",wallrun:"/assets/sfx/wallrun.wav",walljump:"/assets/sfx/walljump.wav",mantle:"/assets/sfx/mantle.wav",land:"/assets/sfx/land.wav",tag:"/assets/sfx/tag.wav",countdown:"/assets/sfx/countdown.wav",round_start:"/assets/sfx/round_start.wav",round_end:"/assets/sfx/round_end.wav"},V=new Map;function at(e,t=.6){const s=rt[e];if(!s)return;let a=V.get(s);a||(a=new Audio(s),V.set(s,a));const r=a.cloneNode(!0);r.volume=t,r.play().catch(()=>{})}function it({size:e=800}){const t=c.useMemo(()=>["#87ceeb","#87ceeb","#bfe9ff","#6aa7d8","#85c1ff","#85c1ff"],[]),s=c.useMemo(()=>t.map(a=>new Te({color:a,side:Oe,depthWrite:!1})),[t]);return n.jsx("mesh",{material:s,children:n.jsx("boxGeometry",{args:[e,e,e]})})}const ct="/assets/face-CnBGMtiw.png",lt={HEIGHT:1.8,EYE_HEIGHT:1.62},Z={PLAYER:lt};function ut({socket:e,selfId:t}){const s=We(e),[a,r]=c.useState(null),[i,l]=c.useState([]),[d,m]=c.useState(""),u=c.useRef(new st),[o,f]=c.useState(null);c.useEffect(()=>{const p=h=>{u.current.push(h)},y=h=>r(h),w=h=>{h!=null&&h.maps&&l(h.maps),h!=null&&h.mapName&&m(h.mapName)},b=h=>{const M=String((h==null?void 0:h.kind)??"").toLowerCase(),P={jump:"jump",slide:"slide",wallrun:"wallrun",walljump:"walljump",mantle:"mantle",land:"land",tag:"tag",countdown:"countdown",round_start:"round_start",round_end:"round_end"}[M]||"jump";try{at(P)}catch{}M==="jump"&&$("--jump",.7),M==="tag"&&$("--hit",1)};return e.on("world:snapshot",p),e.on("round:results",y),e.on("lobby:update",w),e.on("sfx",b),()=>{e.off("world:snapshot",p),e.off("round:results",y),e.off("lobby:update",w),e.off("sfx",b)}},[e]),c.useEffect(()=>{let p=0;const y=()=>{const w=u.current.sample();w&&f(w),p=requestAnimationFrame(y)};return p=requestAnimationFrame(y),()=>cancelAnimationFrame(p)},[]);const x=c.useMemo(()=>(o==null?void 0:o.players.find(p=>p.id===t))??null,[o,t]);return n.jsxs(n.Fragment,{children:[n.jsx(Be,{camera:{position:[0,2,4],fov:80},shadows:!0,dpr:Math.min(typeof window<"u"&&window.devicePixelRatio||1,1.25),gl:{antialias:!0,powerPreference:"high-performance"},children:n.jsxs(c.Suspense,{fallback:null,children:[n.jsx(it,{}),n.jsx("hemisphereLight",{args:["#e6f7ff","#44404a",.9]}),n.jsx("ambientLight",{intensity:.5}),n.jsx("directionalLight",{position:[10,14,6],intensity:1.2,castShadow:!0,"shadow-mapSize":[1024,1024],"shadow-bias":-5e-4}),n.jsx(Je,{}),o==null?void 0:o.players.map(p=>n.jsx(dt,{p,isSelf:p.id===t,isIt:(o==null?void 0:o.itId)===p.id},p.id)),n.jsx(mt,{me:x,inputRef:s})]})}),n.jsxs("div",{className:"hud",style:{position:"fixed",top:12,left:12},children:[n.jsxs("div",{children:["Players: ",(o==null?void 0:o.players.length)??0]}),n.jsxs("div",{children:["Status:"," ",o!=null&&o.intermission?"Intermission":(o==null?void 0:o.itId)===t?"You are IT!":o!=null&&o.itId?"Run!":""]}),n.jsxs("div",{children:["Time: ",Math.ceil((o==null?void 0:o.roundTime)??0),"s"]}),n.jsxs("div",{children:["Map: ",(o==null?void 0:o.mapName)||d]}),n.jsx("div",{style:{marginTop:8},children:"Click to lock mouse"})]}),o&&n.jsx(Qe,{scores:o.scores,itId:o.itId}),n.jsx(et,{results:a}),(o==null?void 0:o.intermission)&&n.jsx(tt,{socket:e,maps:i,current:o.mapName})]})}function $(e,t){const s=document.getElementById("fx");s&&ot(s,e,t,200)}const dt=c.memo(function({p:t,isSelf:s,isIt:a}){var x,p;const r=Fe(J,ct),i=(x=Z.PLAYER)==null?void 0:x.HEIGHT,l=(p=Z.PLAYER)==null?void 0:p.EYE_HEIGHT,d=i/2,m=l-.17,u=c.useMemo(()=>n.jsx("boxGeometry",{args:[.7,i,.7]}),[i]),o=c.useMemo(()=>n.jsx("planeGeometry",{args:[.7,.7]}),[]),f=c.useMemo(()=>n.jsx("meshStandardMaterial",{color:a?"#ff5d5d":"#f0b46d"}),[a]);return n.jsx("group",{position:t.pos,rotation:[0,t.yaw,0],children:!s&&n.jsxs(n.Fragment,{children:[n.jsxs("mesh",{position:[0,d,0],castShadow:!1,receiveShadow:!1,children:[u,f]}),n.jsxs("mesh",{position:[0,m,-.36],rotation:[0,Math.PI,0],children:[o,n.jsx("meshBasicMaterial",{map:r,transparent:!0})]})]})})});function mt({me:e,inputRef:t}){const{camera:s}=Ge(),a=c.useRef(0),r=c.useRef(0),i=c.useRef(80),l=c.useRef(0),d=c.useRef(0),m=c.useRef(0),u=c.useRef(0),o=c.useRef(0),f=c.useRef(0),x=c.useRef(null),p=c.useRef(!1),y=c.useRef(0),w=1.62,b=80,h=96,M=.14,C=1.4,P=.035,ae=.009,ie=.004,T=7.5,ce=14,O=.18,le=-.08,ue=-.065,de=-.1,F=10;return c.useEffect(()=>{var E,v;e&&(a.current=((E=t.current)==null?void 0:E.yaw)??e.yaw,r.current=((v=t.current)==null?void 0:v.pitch)??e.pitch,x.current=e.mode,p.current=!!e.onGround,s.rotation.order="YXZ",s.rotation.y=a.current,s.rotation.x=r.current)},[e,t,s]),Ne((E,v)=>{var D,W;if(!e)return;const g=Math.min(v,1/15),me=e.pos[0],fe=e.pos[1]+w,pe=e.pos[2];s.position.x+=(me-s.position.x)*Math.min(1,g*10),s.position.y+=(fe-s.position.y)*Math.min(1,g*12),s.position.z+=(pe-s.position.z)*Math.min(1,g*10);const he=((D=t.current)==null?void 0:D.yaw)??e.yaw,xe=((W=t.current)==null?void 0:W.pitch)??e.pitch,B=Math.min(1,g*12);a.current+=(he-a.current)*B,r.current+=(xe-r.current)*B;const S=Math.hypot(e.vel[0],e.vel[2]),ye=Math.max(b,Math.min(h,b+S*M));i.current+=(ye-i.current)*Math.min(1,g*2.5);const ge=!!e.onGround||e.mode==="ground"||e.mode==="slide",we=e.mode==="wallrunL"||e.mode==="wallrunR"||e.mode==="mantle",je=ge&&!we,be=S>.2,L=je&&be?Math.max(.6,Math.min(1.4,S/T)):0,Me=C*Math.max(.9,Math.min(1.3,S/T));f.current+=g*Me*Math.PI*2;const G=Math.sin(f.current),ve=Math.sin(f.current*2),Se=-(P*L)*G,Re=-(ae*L)*G,_e=ie*L*ve,A=Math.min(1,g*ce);d.current+=(Se-d.current)*A,m.current+=(Re-m.current)*A,u.current+=(_e-u.current)*A;const j=t.current,Pe=-.04*((j!=null&&j.left?-1:0)+(j!=null&&j.right?1:0));let k=0;e.mode==="wallrunL"&&(k=O),e.mode==="wallrunR"&&(k=-O);const Ee=Pe+k;l.current+=(Ee-l.current)*Math.min(1,g*8);let N=0;e.mode==="slide"&&(N+=le);const R=x.current,Le=p.current,H=!!e.onGround;if(((R==="air"||R==="wallrunL"||R==="wallrunR"||R==="mantle")&&e.mode==="ground"||!Le&&H)&&(o.current=ue,y.current=de),x.current=e.mode,p.current=H,o.current!==0){const Y=Math.sign(-o.current)*Math.min(Math.abs(o.current),F*g);o.current+=Y,Math.abs(o.current)<.001&&(o.current=0)}if(y.current!==0){const Y=(0-y.current)*Math.min(1,g*F);y.current+=Y,Math.abs(y.current)<1e-4&&(y.current=0)}s.rotation.order="YXZ",s.rotation.y=a.current+m.current,s.rotation.x=r.current+(N+o.current)+u.current,s.rotation.z=l.current+d.current,s.position.y+=y.current,s.fov=i.current,s.updateProjectionMatrix()}),null}function ft(){const[e,t]=c.useState("menu"),[s,a]=c.useState(null),[r,i]=c.useState(""),[l,d]=c.useState([]),[m,u]=c.useState("");return c.useEffect(()=>{const f=Ce("http://localhost:3001",{reconnectionAttempts:1/0,reconnectionDelay:1e3});return a(f),f.on("connect",()=>u(f.id??"")),f.on("connect_error",x=>console.warn("socket connect_error",x&&(x.message||x))),f.on("lobby:update",x=>{i(x.roomCode),d(x.players),t("lobby")}),f.on("game:started",()=>t("game")),f.on("disconnect",()=>{t("menu"),d([]),i("")}),()=>{f.disconnect()}},[]),s?n.jsxs("div",{style:{width:"100%",height:"100vh"},children:[e==="menu"&&n.jsx(He,{socket:s}),e==="lobby"&&n.jsx(De,{socket:s,roomCode:r,players:l,selfId:m}),e==="game"&&n.jsx(ut,{socket:s,selfId:m})]}):n.jsx("div",{style:{padding:16},children:"Connecting…"})}Ye.createRoot(document.getElementById("root")).render(n.jsx(Ie.StrictMode,{children:n.jsx(ft,{})}));
