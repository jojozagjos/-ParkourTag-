var ue=Object.defineProperty;var de=(e,t,s)=>t in e?ue(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var N=(e,t,s)=>de(e,typeof t!="symbol"?t+"":t,s);import{r as c,j as n,b as me,d as fe}from"./vendor_react-DAfT3zq5.js";import{l as pe}from"./vendor-C8VZyxSH.js";import{T as H,R as Y,M as D,a as he,B as xe,C as ye,u as ge,b as je}from"./vendor_three-DveAjyFm.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&a(u)}).observe(document,{childList:!0,subtree:!0});function s(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=s(o);fetch(o.href,r)}})();function be({socket:e}){const[t,s]=c.useState("Runner"),[a,o]=c.useState("");function r(){e.emit("room:create",{name:t})}function u(){a&&e.emit("room:join",{code:a.toUpperCase(),name:t})}return n.jsx("div",{style:{display:"grid",placeItems:"center",height:"100%"},children:n.jsxs("div",{className:"panel",children:[n.jsx("h1",{style:{marginTop:0},children:"Parkour Tag"}),n.jsx("label",{style:{display:"block",marginBottom:8},children:"Display name"}),n.jsx("input",{value:t,onChange:l=>s(l.target.value),placeholder:"Your name",style:{width:"100%",marginBottom:12}}),n.jsxs("div",{style:{display:"flex",gap:8},children:[n.jsx("button",{onClick:r,children:"Host"}),n.jsx("input",{value:a,onChange:l=>o(l.target.value),placeholder:"Room code",style:{flex:1}}),n.jsx("button",{onClick:u,children:"Join"})]}),n.jsx("p",{style:{opacity:.85,marginTop:12},children:"Host creates a room. Others enter the code to join."})]})})}function we({socket:e,roomCode:t,players:s,selfId:a}){const o=s.find(f=>f.id===a),r=o==null?void 0:o.host;function u(){e.emit("lobby:ready",{ready:!(o!=null&&o.ready)})}function l(){e.emit("game:start")}return n.jsxs("div",{style:{padding:24},children:[n.jsxs("h2",{children:["Room ",t]}),n.jsxs("div",{style:{display:"flex",gap:24,alignItems:"flex-start"},children:[n.jsxs("div",{children:[n.jsx("h3",{children:"Players"}),n.jsx("ul",{children:s.map(f=>n.jsxs("li",{children:[f.name," ",f.host?"(host)":""," ",f.ready?"✅":"⏳"," ",f.id===a?"← you":""]},f.id))})]}),n.jsxs("div",{style:{display:"flex",gap:12},children:[n.jsx("button",{onClick:u,children:o!=null&&o.ready?"Unready":"Ready"}),r&&n.jsx("button",{onClick:l,children:"Start"})]})]}),n.jsx("p",{style:{marginTop:16},children:"All players ready up. Host can start."}),n.jsx("p",{style:{opacity:.8},children:"Map voting will appear during intermission."})]})}function ve(e){const t=c.useRef({forward:!1,back:!1,left:!1,right:!1,jump:!1,sprint:!1,crouch:!1,yaw:0,pitch:0}),s=.0025,a=Math.PI/2*.95;return c.useEffect(()=>{const o=(m,d)=>{if(!m.repeat){switch(m.code){case"KeyW":case"ArrowUp":t.current.forward=d;break;case"KeyS":case"ArrowDown":t.current.back=d;break;case"KeyA":case"ArrowLeft":t.current.left=d;break;case"KeyD":case"ArrowRight":t.current.right=d;break;case"Space":t.current.jump=d;break;case"ShiftLeft":case"ShiftRight":t.current.sprint=d;break;case"ControlLeft":case"ControlRight":t.current.crouch=d;break;default:return}e.emit("input",{...t.current})}},r=m=>{document.pointerLockElement===document.body&&(t.current.yaw+=m.movementX*s,t.current.pitch-=m.movementY*s,t.current.pitch>a&&(t.current.pitch=a),t.current.pitch<-a&&(t.current.pitch=-a),e.emit("input",{...t.current}))},u=()=>{var m;if(!document.pointerLockElement){const d=document.body;(m=d.requestPointerLock)==null||m.call(d)}},l=m=>o(m,!0),f=m=>o(m,!1);return window.addEventListener("keydown",l),window.addEventListener("keyup",f),window.addEventListener("mousemove",r),window.addEventListener("click",u),()=>{window.removeEventListener("keydown",l),window.removeEventListener("keyup",f),window.removeEventListener("mousemove",r),window.removeEventListener("click",u)}},[e]),t}const X="ParkourYard",U=[{min:[-30,-.5,-30],max:[30,0,30]},{min:[-10,1.5,-10],max:[-3,2,4]},{min:[3,1.2,-6],max:[12,1.9,6]},{min:[-14,3,8],max:[-2,3.5,20]},{min:[6,3.2,10],max:[16,3.8,22]},{min:[-20,0,-18],max:[-18,6,18]},{min:[18,0,-18],max:[20,6,18]},{min:[-2,.8,-2],max:[2,1.6,2]},{min:[-6,1.4,6],max:[-3,2.4,9]},{min:[4,2,-12],max:[9,3,-8]},{min:[-15,.5,-5],max:[-11,1,5]},{min:[-15,1,-5],max:[-12,1.5,5]},{min:[-15,1.5,-5],max:[-13,2,5]},{min:[-25,.5,25],max:[-10,2.5,28]},{min:[10,.5,-28],max:[25,2.5,-25]}],W=[[-8,2.2,0],[8,2.2,0],[0,2.2,-8],[0,2.2,8],[-12,2.6,12],[12,2.6,-12]],Me={name:X,aabbs:U,spawnPoints:W},Se=Object.freeze(Object.defineProperty({__proto__:null,aabbs:U,default:Me,name:X,spawnPoints:W},Symbol.toStringTag,{value:"Module"})),V="Rooftops",$=[{min:[-40,-.5,-40],max:[40,0,40]},{min:[-15,3,-10],max:[15,3.5,10]},{min:[-30,6,-5],max:[-10,6.5,5]},{min:[10,6.5,-8],max:[30,7,8]},{min:[-5,1.8,-20],max:[5,2.3,-8]},{min:[-22,9,-2],max:[-8,9.3,12]},{min:[8,9.5,-12],max:[24,9.9,2]},{min:[-40,.5,36],max:[40,1.5,38]},{min:[-38,.5,-38],max:[-20,1.5,-36]}],J=[[-12,3.8,-2],[12,3.8,2],[-24,6.8,0],[24,6.9,0],[-2,2.2,-14],[2,2.2,-14]],_e={name:V,aabbs:$,spawnPoints:J},Re=Object.freeze(Object.defineProperty({__proto__:null,aabbs:$,default:_e,name:V,spawnPoints:J},Symbol.toStringTag,{value:"Module"})),Q=["ParkourYard","Rooftops"],Pe={default:"ParkourYard",options:Q},ke=Object.freeze(Object.defineProperty({__proto__:null,default:Pe,options:Q},Symbol.toStringTag,{value:"Module"})),Le={default:"ParkourYard"},v={},G=Object.assign({"../../shared/maps/ParkourYard.json":Se,"../../shared/maps/Rooftops.json":Re,"../../shared/maps/index.json":ke});for(const e of Object.keys(G)){const t=e.split("/").pop().replace(".json","");v[t]=G[e]}const Ee=v[Le.default]||v[Object.keys(v)[0]];function Ce(){const e=new H,t=c.useMemo(()=>{const r=e.load("/assets/textures/floor_grid.png");return r.wrapS=r.wrapT=Y,r.repeat.set(10,10),r},[]),s=c.useMemo(()=>{const r=e.load("/assets/textures/wall_noise.png");return r.wrapS=r.wrapT=Y,r.repeat.set(4,4),r},[]),a=c.useMemo(()=>new D({map:t}),[t]),o=c.useMemo(()=>new D({map:s}),[s]);return n.jsx("group",{children:Ee.aabbs.map((r,u)=>{const l=[r.max[0]-r.min[0],r.max[1]-r.min[1],r.max[2]-r.min[2]],f=[(r.min[0]+r.max[0])/2,(r.min[1]+r.max[1])/2,(r.min[2]+r.max[2])/2],m=u===0?a:o;return n.jsxs("mesh",{position:f,castShadow:!0,receiveShadow:!0,children:[n.jsx("boxGeometry",{args:l}),n.jsx("primitive",{object:m,attach:"material"})]},u)})})}function Ie({scores:e,itId:t}){const s=Object.entries(e).sort((a,o)=>o[1]-a[1]);return n.jsxs("div",{style:{position:"fixed",top:12,right:12,background:"rgba(0,0,0,0.35)",padding:"8px 12px",borderRadius:8,minWidth:160},children:[n.jsx("div",{style:{opacity:.8,marginBottom:6},children:"Scoreboard"}),s.map(([a,o])=>n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:12},children:[n.jsxs("span",{children:[a===t?"IT":"P",":",a.slice(0,4)]}),n.jsx("span",{children:Math.round(o)})]},a))]})}function Ae({results:e}){return e?n.jsx("div",{style:{position:"fixed",inset:0,display:"grid",placeItems:"center",background:"rgba(0,0,0,0.5)"},children:n.jsxs("div",{style:{background:"#0b1128",padding:24,borderRadius:12,width:360},children:[n.jsx("h3",{style:{marginTop:0},children:"Round Results"}),n.jsx("ol",{children:e.placement.map(t=>n.jsxs("li",{style:{display:"flex",justifyContent:"space-between"},children:[n.jsx("span",{children:t.name}),n.jsx("span",{children:t.score})]},t.id))}),n.jsx("p",{style:{opacity:.8},children:"Intermission. Next map loading soon."})]})}):null}function Oe({socket:e,maps:t,current:s}){const a=c.useMemo(()=>t,[t]);return a!=null&&a.length?n.jsxs("div",{style:{position:"fixed",bottom:12,left:"50%",transform:"translateX(-50%)",background:"rgba(0,0,0,0.35)",padding:"10px 12px",borderRadius:10,display:"flex",gap:10},children:[n.jsx("span",{style:{opacity:.8,marginRight:6},children:"Vote next map:"}),a.map(o=>n.jsx("button",{onClick:()=>e.emit("vote:map",{name:o}),style:{padding:"8px 10px",borderRadius:8,border:"1px solid #30407a",background:o===s?"#1b2a5a":"#0d1430",color:"#fff"},children:o},o))]}):null}const Be=70;function C(e,t,s){return e+(t-e)*s}function K(e,t,s){let a=t-e;for(;a>Math.PI;)a-=Math.PI*2;for(;a<-Math.PI;)a+=Math.PI*2;return e+a*s}class Te{constructor(){N(this,"buf",[])}push(t){this.buf.push({t:performance.now(),snap:t}),this.buf.length>20&&this.buf.shift()}sample(){var m;if(this.buf.length<2)return((m=this.buf[this.buf.length-1])==null?void 0:m.snap)||null;const t=performance.now()-Be;let s=0;for(;s+1<this.buf.length&&this.buf[s+1].t<t;)s++;const a=this.buf[s],o=this.buf[s+1]||a,r=Math.max(1,o.t-a.t),u=Math.min(1,Math.max(0,(t-a.t)/r));function l(d,p){return[C(d[0],p[0],u),C(d[1],p[1],u),C(d[2],p[2],u)]}const f=[];for(const d of a.snap.players){const p=o.snap.players.find(i=>i.id===d.id)||d;f.push({...d,pos:l(d.pos,p.pos),vel:l(d.vel,p.vel),yaw:K(d.yaw,p.yaw,u),pitch:K(d.pitch,p.pitch,u),mode:p.mode})}return{...o.snap,players:f}}}function Fe(e,t,s=1,a=220){e.style.setProperty(t,String(s));const o=performance.now();function r(){const u=performance.now()-o,l=Math.max(0,1-u/a);e.style.setProperty(t,String(l*s)),l>0&&requestAnimationFrame(r)}requestAnimationFrame(r)}const Ne={jump:"/assets/sfx/jump.wav",slide:"/assets/sfx/slide.wav",wallrun:"/assets/sfx/wallrun.wav",walljump:"/assets/sfx/walljump.wav",mantle:"/assets/sfx/mantle.wav",land:"/assets/sfx/land.wav",tag:"/assets/sfx/tag.wav",countdown:"/assets/sfx/countdown.wav",round_start:"/assets/sfx/round_start.wav",round_end:"/assets/sfx/round_end.wav"},q=new Map;function Ye(e,t=.6){const s=Ne[e];if(!s)return;let a=q.get(s);a||(a=new Audio(s),q.set(s,a));const o=a.cloneNode(!0);o.volume=t,o.play().catch(()=>{})}function De({size:e=800}){const t=c.useMemo(()=>["#87ceeb","#87ceeb","#bfe9ff","#6aa7d8","#85c1ff","#85c1ff"],[]),s=c.useMemo(()=>t.map(a=>new he({color:a,side:xe,depthWrite:!1})),[t]);return n.jsx("mesh",{material:s,children:n.jsx("boxGeometry",{args:[e,e,e]})})}const Ge="/assets/face-CnBGMtiw.png";function g(e,t,s){return Math.max(t,Math.min(s,e))}function Ke({socket:e,selfId:t}){const s=ve(e),[a,o]=c.useState(null),[r,u]=c.useState(null),[l,f]=c.useState([]),[m,d]=c.useState(""),p=c.useRef(new Te),[i,M]=c.useState(null);c.useEffect(()=>{const x=h=>{p.current.push(h),o(h)};return e.on("world:snapshot",x),e.on("round:results",h=>u(h)),e.on("lobby:update",h=>{h!=null&&h.maps&&f(h.maps),h!=null&&h.mapName&&d(h.mapName)}),e.on("sfx",h=>{const j=String(h.kind||"").toLowerCase(),_={jump:"jump",slide:"slide",wallrun:"wallrun",walljump:"walljump",mantle:"mantle",land:"land",tag:"tag",countdown:"countdown",round_start:"round_start",round_end:"round_end"}[j]||"jump";try{Ye(_)}catch{}j==="jump"&&z("--jump",.7),j==="tag"&&z("--hit",1)}),()=>{e.off("world:snapshot",x),e.off("round:results"),e.off("lobby:update"),e.off("sfx")}},[e]),c.useEffect(()=>{let x=0;const h=()=>{const j=p.current.sample();j&&M(j),x=requestAnimationFrame(h)};return x=requestAnimationFrame(h),()=>cancelAnimationFrame(x)},[]);const S=c.useMemo(()=>i==null?void 0:i.players.find(x=>x.id===t),[i,t]);return n.jsxs(n.Fragment,{children:[n.jsxs(ye,{camera:{position:[0,2,4],fov:80},shadows:!0,children:[n.jsx(De,{}),n.jsx("hemisphereLight",{args:["#e6f7ff","#44404a",.9]}),n.jsx("ambientLight",{intensity:.5}),n.jsx("directionalLight",{position:[10,14,6],intensity:1.2,castShadow:!0,"shadow-mapSize-width":2048,"shadow-mapSize-height":2048,"shadow-bias":-5e-4}),n.jsx(Ce,{}),i==null?void 0:i.players.map(x=>n.jsx(qe,{p:x,isSelf:x.id===t,isIt:(i==null?void 0:i.itId)===x.id},x.id)),n.jsx(ze,{me:S||null,inputRef:s})]}),n.jsxs("div",{className:"hud",style:{position:"fixed",top:12,left:12},children:[n.jsxs("div",{children:["Players: ",(i==null?void 0:i.players.length)??0]}),n.jsxs("div",{children:["Status: ",i!=null&&i.intermission?"Intermission":(i==null?void 0:i.itId)===t?"You are IT!":i!=null&&i.itId?"Run!":""]}),n.jsxs("div",{children:["Time: ",Math.ceil((i==null?void 0:i.roundTime)??0),"s"]}),n.jsxs("div",{children:["Map: ",(i==null?void 0:i.mapName)||m]}),n.jsx("div",{style:{marginTop:8},children:"Click to lock mouse"})]}),i&&n.jsx(Ie,{scores:i.scores,itId:i.itId}),n.jsx(Ae,{results:r}),(i==null?void 0:i.intermission)&&n.jsx(Oe,{socket:e,maps:l,current:i.mapName})]})}function z(e,t){const s=document.getElementById("fx");s&&Fe(s,e,t,200)}function qe({p:e,isSelf:t,isIt:s}){const a=c.useMemo(()=>new H().load(Ge),[]);return n.jsxs("group",{position:e.pos,rotation:[0,e.yaw,0],children:[n.jsxs("mesh",{castShadow:!0,children:[n.jsx("boxGeometry",{args:[.7,1.8,.7]}),n.jsx("meshStandardMaterial",{color:t?"#6bd3ff":s?"#ff5d5d":"#f0b46d"})]}),n.jsxs("mesh",{position:[0,.5,-.36],rotation:[0,Math.PI,0],children:[n.jsx("planeGeometry",{args:[.7,.7]}),n.jsx("meshBasicMaterial",{map:a,transparent:!0})]})]})}function ze({me:e,inputRef:t}){const{camera:s}=ge(),a=c.useRef(80),o=c.useRef(0),r=c.useRef(0),u=c.useRef(0),l=c.useRef({x:0,y:0}),f=c.useRef(null),m=c.useRef(null),d=1.62,p=80,i=98,M=.18,S=9,x=.03,h=.02,j=.22,I=-.1,_=-.06,Z=10;return c.useEffect(()=>{e&&(f.current=e.mode,m.current=e.pos[1])},[e]),je((Xe,y)=>{var T,F;if(!e)return;const R=e.pos,ee=((T=t.current)==null?void 0:T.yaw)??e.yaw,te=((F=t.current)==null?void 0:F.pitch)??e.pitch,P=[R[0],R[1]+d,R[2]];s.position.x+=(P[0]-s.position.x)*g(y*10,0,1),s.position.y+=(P[1]-s.position.y)*g(y*12,0,1),s.position.z+=(P[2]-s.position.z)*g(y*10,0,1),s.rotation.order="YXZ";const A=g(y*12,0,1);s.rotation.y+=(ee-s.rotation.y)*A,s.rotation.x+=(te-s.rotation.x)*A;const k=Math.hypot(e.vel[0],e.vel[2]),ne=g(p+k*M,p,i);a.current+=(ne-a.current)*g(y*4,0,1),s.fov=a.current,s.updateProjectionMatrix();const O=e.pos[1],se=m.current==null?0:Math.abs(O-m.current);m.current=O;const re=k>.5,oe=e.mode==="ground"||se<.002,ae=S*g(k/8,.5,1.6);if(oe&&re){u.current+=y*ae*Math.PI*2;const E=Math.sin(u.current)*h,le=Math.max(0,Math.cos(u.current))*x;l.current.x+=(E-l.current.x)*g(y*10,0,1),l.current.y+=(le-l.current.y)*g(y*10,0,1)}else l.current.x+=(0-l.current.x)*g(y*6,0,1),l.current.y+=(0-l.current.y)*g(y*6,0,1);s.rotation.x+=l.current.y*.25,s.rotation.y+=l.current.x*.15,s.position.y+=l.current.y*.05;const b=t.current,ie=-.06*((b!=null&&b.left?-1:0)+(b!=null&&b.right?1:0));let L=0;e.mode==="wallrunL"&&(L=j),e.mode==="wallrunR"&&(L=-j);const ce=ie+L;o.current+=(ce-o.current)*g(y*6,0,1),s.rotation.z=o.current;let B=0;e.mode==="slide"&&(B+=I);const w=f.current;if((w==="air"||w==="wallrunL"||w==="wallrunR"||w==="mantle")&&e.mode==="ground"&&(r.current=_),f.current=e.mode,r.current!==0){const E=Math.sign(-r.current)*Math.min(Math.abs(r.current),Z*y);r.current+=E,Math.abs(r.current)<.001&&(r.current=0)}s.rotation.x+=B+r.current}),null}function He(){const[e,t]=c.useState("menu"),[s,a]=c.useState(null),[o,r]=c.useState(""),[u,l]=c.useState([]),[f,m]=c.useState("");return c.useEffect(()=>{const p=pe("http://localhost:3001",{reconnectionAttempts:1/0,reconnectionDelay:1e3});return a(p),p.on("connect",()=>m(p.id??"")),p.on("connect_error",i=>console.warn("socket connect_error",i&&(i.message||i))),p.on("lobby:update",i=>{r(i.roomCode),l(i.players),t("lobby")}),p.on("game:started",()=>t("game")),p.on("disconnect",()=>{t("menu"),l([]),r("")}),()=>{p.disconnect()}},[]),s?n.jsxs("div",{style:{width:"100%",height:"100vh"},children:[e==="menu"&&n.jsx(be,{socket:s}),e==="lobby"&&n.jsx(we,{socket:s,roomCode:o,players:u,selfId:f}),e==="game"&&n.jsx(Ke,{socket:s,selfId:f})]}):n.jsx("div",{style:{padding:16},children:"Connecting…"})}me.createRoot(document.getElementById("root")).render(n.jsx(fe.StrictMode,{children:n.jsx(He,{})}));
