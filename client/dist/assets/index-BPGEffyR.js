var O=Object.defineProperty;var F=(t,e,r)=>e in t?O(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var w=(t,e,r)=>F(t,typeof e!="symbol"?e+"":e,r);import{r as u,j as n,b as N,d as B}from"./vendor_react-DAfT3zq5.js";import{l as Y}from"./vendor-C8VZyxSH.js";import{T as q,R as v,M as S,a as H,B as z,C as D,u as K,b as U}from"./vendor_three-DveAjyFm.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();function G({socket:t}){const[e,r]=u.useState("Runner"),[i,o]=u.useState("");function a(){t.emit("room:create",{name:e})}function c(){i&&t.emit("room:join",{code:i.toUpperCase(),name:e})}return n.jsx("div",{style:{display:"grid",placeItems:"center",height:"100%"},children:n.jsxs("div",{className:"panel",children:[n.jsx("h1",{style:{marginTop:0},children:"Parkour Tag"}),n.jsx("label",{style:{display:"block",marginBottom:8},children:"Display name"}),n.jsx("input",{value:e,onChange:l=>r(l.target.value),placeholder:"Your name",style:{width:"100%",marginBottom:12}}),n.jsxs("div",{style:{display:"flex",gap:8},children:[n.jsx("button",{onClick:a,children:"Host"}),n.jsx("input",{value:i,onChange:l=>o(l.target.value),placeholder:"Room code",style:{flex:1}}),n.jsx("button",{onClick:c,children:"Join"})]}),n.jsx("p",{style:{opacity:.85,marginTop:12},children:"Host creates a room. Others enter the code to join."})]})})}function W({socket:t,roomCode:e,players:r,selfId:i}){const o=r.find(m=>m.id===i),a=o==null?void 0:o.host;function c(){t.emit("lobby:ready",{ready:!(o!=null&&o.ready)})}function l(){t.emit("game:start")}return n.jsxs("div",{style:{padding:24},children:[n.jsxs("h2",{children:["Room ",e]}),n.jsxs("div",{style:{display:"flex",gap:24,alignItems:"flex-start"},children:[n.jsxs("div",{children:[n.jsx("h3",{children:"Players"}),n.jsx("ul",{children:r.map(m=>n.jsxs("li",{children:[m.name," ",m.host?"(host)":""," ",m.ready?"✅":"⏳"," ",m.id===i?"← you":""]},m.id))})]}),n.jsxs("div",{style:{display:"flex",gap:12},children:[n.jsx("button",{onClick:c,children:o!=null&&o.ready?"Unready":"Ready"}),a&&n.jsx("button",{onClick:l,children:"Start"})]})]}),n.jsx("p",{style:{marginTop:16},children:"All players ready up. Host can start."}),n.jsx("p",{style:{opacity:.8},children:"Map voting will appear during intermission."})]})}function X(t){const e=u.useRef({forward:!1,back:!1,left:!1,right:!1,jump:!1,sprint:!1,crouch:!1,yaw:0,pitch:0}),r=.0025,i=Math.PI/2*.95;return u.useEffect(()=>{function o(d,p){if(!d.repeat){switch(d.code){case"KeyW":case"ArrowUp":e.current.forward=p;break;case"KeyS":case"ArrowDown":e.current.back=p;break;case"KeyA":case"ArrowLeft":e.current.left=p;break;case"KeyD":case"ArrowRight":e.current.right=p;break;case"Space":e.current.jump=p;break;case"ShiftLeft":case"ShiftRight":e.current.sprint=p;break;case"ControlLeft":case"ControlRight":e.current.crouch=p;break}t.emit("input",{...e.current,forward:!!e.current.forward,back:!!e.current.back})}}const a=d=>o(d,!0),c=d=>o(d,!1);function l(d){document.pointerLockElement&&(e.current.yaw-=d.movementX*r,e.current.pitch-=d.movementY*r,e.current.pitch>i&&(e.current.pitch=i),e.current.pitch<-i&&(e.current.pitch=-i),t.emit("input",{...e.current,forward:!!e.current.forward,back:!!e.current.back}))}function m(d){const p=d.target&&d.target||document.body;if(!document.pointerLockElement&&p.requestPointerLock)try{p.requestPointerLock()}catch{document.body.requestPointerLock&&document.body.requestPointerLock()}}return window.addEventListener("keydown",a),window.addEventListener("keyup",c),window.addEventListener("mousemove",l),window.addEventListener("click",m),()=>{window.removeEventListener("keydown",a),window.removeEventListener("keyup",c),window.removeEventListener("mousemove",l),window.removeEventListener("click",m)}},[t]),e}const R="ParkourYard",P=[{min:[-30,-.5,-30],max:[30,0,30]},{min:[-10,1.5,-10],max:[-3,2,4]},{min:[3,1.2,-6],max:[12,1.9,6]},{min:[-14,3,8],max:[-2,3.5,20]},{min:[6,3.2,10],max:[16,3.8,22]},{min:[-20,0,-18],max:[-18,6,18]},{min:[18,0,-18],max:[20,6,18]},{min:[-2,.8,-2],max:[2,1.6,2]},{min:[-6,1.4,6],max:[-3,2.4,9]},{min:[4,2,-12],max:[9,3,-8]},{min:[-15,.5,-5],max:[-11,1,5]},{min:[-15,1,-5],max:[-12,1.5,5]},{min:[-15,1.5,-5],max:[-13,2,5]},{min:[-25,.5,25],max:[-10,2.5,28]},{min:[10,.5,-28],max:[25,2.5,-25]}],L=[[-8,2.2,0],[8,2.2,0],[0,2.2,-8],[0,2.2,8],[-12,2.6,12],[12,2.6,-12]],$={name:R,aabbs:P,spawnPoints:L},J=Object.freeze(Object.defineProperty({__proto__:null,aabbs:P,default:$,name:R,spawnPoints:L},Symbol.toStringTag,{value:"Module"})),C="Rooftops",E=[{min:[-40,-.5,-40],max:[40,0,40]},{min:[-15,3,-10],max:[15,3.5,10]},{min:[-30,6,-5],max:[-10,6.5,5]},{min:[10,6.5,-8],max:[30,7,8]},{min:[-5,1.8,-20],max:[5,2.3,-8]},{min:[-22,9,-2],max:[-8,9.3,12]},{min:[8,9.5,-12],max:[24,9.9,2]},{min:[-40,.5,36],max:[40,1.5,38]},{min:[-38,.5,-38],max:[-20,1.5,-36]}],T=[[-12,3.8,-2],[12,3.8,2],[-24,6.8,0],[24,6.9,0],[-2,2.2,-14],[2,2.2,-14]],V={name:C,aabbs:E,spawnPoints:T},Z=Object.freeze(Object.defineProperty({__proto__:null,aabbs:E,default:V,name:C,spawnPoints:T},Symbol.toStringTag,{value:"Module"})),A=["ParkourYard","Rooftops"],Q={default:"ParkourYard",options:A},ee=Object.freeze(Object.defineProperty({__proto__:null,default:Q,options:A},Symbol.toStringTag,{value:"Module"})),te={default:"ParkourYard"},b={},k=Object.assign({"../../shared/maps/ParkourYard.json":J,"../../shared/maps/Rooftops.json":Z,"../../shared/maps/index.json":ee});for(const t of Object.keys(k)){const e=t.split("/").pop().replace(".json","");b[e]=k[t]}const ne=b[te.default]||b[Object.keys(b)[0]];function se(){const t=new q,e=u.useMemo(()=>{const a=t.load("/assets/textures/floor_grid.png");return a.wrapS=a.wrapT=v,a.repeat.set(10,10),a},[]),r=u.useMemo(()=>{const a=t.load("/assets/textures/wall_noise.png");return a.wrapS=a.wrapT=v,a.repeat.set(4,4),a},[]),i=u.useMemo(()=>new S({map:e}),[e]),o=u.useMemo(()=>new S({map:r}),[r]);return n.jsx("group",{children:ne.aabbs.map((a,c)=>{const l=[a.max[0]-a.min[0],a.max[1]-a.min[1],a.max[2]-a.min[2]],m=[(a.min[0]+a.max[0])/2,(a.min[1]+a.max[1])/2,(a.min[2]+a.max[2])/2],d=c===0?i:o;return n.jsxs("mesh",{position:m,castShadow:!0,receiveShadow:!0,children:[n.jsx("boxGeometry",{args:l}),n.jsx("primitive",{object:d,attach:"material"})]},c)})})}function oe({scores:t,itId:e}){const r=Object.entries(t).sort((i,o)=>o[1]-i[1]);return n.jsxs("div",{style:{position:"fixed",top:12,right:12,background:"rgba(0,0,0,0.35)",padding:"8px 12px",borderRadius:8,minWidth:160},children:[n.jsx("div",{style:{opacity:.8,marginBottom:6},children:"Scoreboard"}),r.map(([i,o])=>n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:12},children:[n.jsxs("span",{children:[i===e?"IT":"P",":",i.slice(0,4)]}),n.jsx("span",{children:Math.round(o)})]},i))]})}function re({results:t}){return t?n.jsx("div",{style:{position:"fixed",inset:0,display:"grid",placeItems:"center",background:"rgba(0,0,0,0.5)"},children:n.jsxs("div",{style:{background:"#0b1128",padding:24,borderRadius:12,width:360},children:[n.jsx("h3",{style:{marginTop:0},children:"Round Results"}),n.jsx("ol",{children:t.placement.map(e=>n.jsxs("li",{style:{display:"flex",justifyContent:"space-between"},children:[n.jsx("span",{children:e.name}),n.jsx("span",{children:e.score})]},e.id))}),n.jsx("p",{style:{opacity:.8},children:"Intermission. Next map loading soon."})]})}):null}function ae({socket:t,maps:e,current:r}){const i=u.useMemo(()=>e,[e]);return i!=null&&i.length?n.jsxs("div",{style:{position:"fixed",bottom:12,left:"50%",transform:"translateX(-50%)",background:"rgba(0,0,0,0.35)",padding:"10px 12px",borderRadius:10,display:"flex",gap:10},children:[n.jsx("span",{style:{opacity:.8,marginRight:6},children:"Vote next map:"}),i.map(o=>n.jsx("button",{onClick:()=>t.emit("vote:map",{name:o}),style:{padding:"8px 10px",borderRadius:8,border:"1px solid #30407a",background:o===r?"#1b2a5a":"#0d1430",color:"#fff"},children:o},o))]}):null}const ie=100;class ce{constructor(){w(this,"buf",[])}push(e){this.buf.push({t:performance.now(),snap:e}),this.buf.length>10&&this.buf.shift()}sample(){var p;if(this.buf.length<2)return((p=this.buf[this.buf.length-1])==null?void 0:p.snap)||null;const e=performance.now()-ie;let r=0;for(;r+1<this.buf.length&&this.buf[r+1].t<e;)r++;const i=this.buf[r],o=this.buf[r+1]||i,a=Math.max(1,o.t-i.t),c=Math.min(1,Math.max(0,(e-i.t)/a));function l(s,f){return s+(f-s)*c}function m(s,f){return[l(s[0],f[0]),l(s[1],f[1]),l(s[2],f[2])]}const d=[];for(const s of i.snap.players){const f=o.snap.players.find(j=>j.id===s.id)||s;d.push({...s,pos:m(s.pos,f.pos),vel:m(s.vel,f.vel),yaw:l(s.yaw,f.yaw),pitch:l(s.pitch,f.pitch),mode:f.mode})}return{...o.snap,players:d}}}function le(t,e,r=1,i=220){t.style.setProperty(e,String(r));const o=performance.now();function a(){const c=performance.now()-o,l=Math.max(0,1-c/i);t.style.setProperty(e,String(l*r)),l>0&&requestAnimationFrame(a)}requestAnimationFrame(a)}const ue={jump:"/assets/sfx/jump.wav",slide:"/assets/sfx/slide.wav",wallrun:"/assets/sfx/wallrun.wav",walljump:"/assets/sfx/walljump.wav",mantle:"/assets/sfx/mantle.wav",land:"/assets/sfx/land.wav",tag:"/assets/sfx/tag.wav",countdown:"/assets/sfx/countdown.wav",round_start:"/assets/sfx/round_start.wav",round_end:"/assets/sfx/round_end.wav"},M=new Map;function de(t,e=.6){const r=ue[t];if(!r)return;let i=M.get(r);i||(i=new Audio(r),M.set(r,i));const o=i.cloneNode(!0);o.volume=e,o.play().catch(()=>{})}function me({size:t=800}){const e=u.useMemo(()=>["#87ceeb","#87ceeb","#bfe9ff","#6aa7d8","#85c1ff","#85c1ff"],[]),r=u.useMemo(()=>e.map(i=>new H({color:i,side:z,depthWrite:!1})),[e]);return n.jsx("mesh",{material:r,children:n.jsx("boxGeometry",{args:[t,t,t]})})}function y(t,e,r){return Math.max(e,Math.min(r,t))}function fe({socket:t,selfId:e}){X(t);const[r,i]=u.useState(null),[o,a]=u.useState(null),[c,l]=u.useState([]),[m,d]=u.useState(""),p=u.useRef(new ce),[s,f]=u.useState(null);u.useEffect(()=>{const x=h=>{p.current.push(h),i(h)};return t.on("world:snapshot",x),t.on("round:results",h=>a(h)),t.on("lobby:update",h=>{h!=null&&h.maps&&l(h.maps),h!=null&&h.mapName&&d(h.mapName)}),t.on("sfx",h=>{const g=String(h.kind||"").toLowerCase(),I={jump:"jump",slide:"slide",wallrun:"wallrun",walljump:"walljump",mantle:"mantle",land:"land",tag:"tag",countdown:"countdown",round_start:"round_start",round_end:"round_end"}[g]||"jump";try{de(I)}catch{}g==="jump"&&_("--jump",.7),g==="tag"&&_("--hit",1)}),()=>{t.off("world:snapshot",x),t.off("round:results"),t.off("lobby:update"),t.off("sfx")}},[t]),u.useEffect(()=>{let x=0;const h=()=>{const g=p.current.sample();g&&f(g),x=requestAnimationFrame(h)};return x=requestAnimationFrame(h),()=>cancelAnimationFrame(x)},[]);const j=u.useMemo(()=>s==null?void 0:s.players.find(x=>x.id===e),[s,e]);return n.jsxs(n.Fragment,{children:[n.jsxs(D,{camera:{position:[0,2,4],fov:80},shadows:!0,children:[n.jsx(me,{}),n.jsx("hemisphereLight",{args:["#e6f7ff","#44404a",.9]}),n.jsx("ambientLight",{intensity:.5}),n.jsx("directionalLight",{position:[10,14,6],intensity:1.2,castShadow:!0,"shadow-mapSize-width":2048,"shadow-mapSize-height":2048,"shadow-bias":-5e-4}),n.jsx(se,{}),s==null?void 0:s.players.map(x=>n.jsx(pe,{p:x,isSelf:x.id===e,isIt:(s==null?void 0:s.itId)===x.id},x.id)),n.jsx(he,{me:j||null})]}),n.jsxs("div",{className:"hud",style:{position:"fixed",top:12,left:12},children:[n.jsxs("div",{children:["Players: ",(s==null?void 0:s.players.length)??0]}),n.jsxs("div",{children:["Status: ",s!=null&&s.intermission?"Intermission":(s==null?void 0:s.itId)===e?"You are IT!":s!=null&&s.itId?"Run!":""]}),n.jsxs("div",{children:["Time: ",Math.ceil((s==null?void 0:s.roundTime)??0),"s"]}),n.jsxs("div",{children:["Map: ",(s==null?void 0:s.mapName)||m]}),n.jsx("div",{style:{marginTop:8},children:"Click to lock mouse"})]}),s&&n.jsx(oe,{scores:s.scores,itId:s.itId}),n.jsx(re,{results:o}),(s==null?void 0:s.intermission)&&n.jsx(ae,{socket:t,maps:c,current:s.mapName})]})}function _(t,e){const r=document.getElementById("fx");r&&le(r,t,e,200)}function pe({p:t,isSelf:e,isIt:r}){return n.jsx("group",{position:t.pos,rotation:[0,t.yaw,0],children:n.jsxs("mesh",{castShadow:!0,children:[n.jsx("boxGeometry",{args:[.7,1.8,.7]}),n.jsx("meshStandardMaterial",{color:e?"#6bd3ff":r?"#ff5d5d":"#f0b46d"})]})})}function he({me:t}){const{camera:e}=K(),r=e,i=u.useRef(0),o=u.useRef(0);return U((a,c)=>{if(!t)return;const l=[t.pos[0],t.pos[1]+1.62,t.pos[2]];e.position.x+=(l[0]-e.position.x)*y(c*10,0,1),e.position.y+=(l[1]-e.position.y)*y(c*12,0,1),e.position.z+=(l[2]-e.position.z)*y(c*10,0,1),e.rotation.order="YXZ";const m=y(c*12,0,1);e.rotation.y+=(t.yaw-e.rotation.y)*m,e.rotation.x+=(t.pitch-e.rotation.x)*m;const d=Math.hypot(t.vel[0],t.vel[2]),p=y(80+(d-5)*2,80,98);r.fov+=(p-r.fov)*y(c*4,0,1),r.updateProjectionMatrix();let s=0;t.mode==="wallrunL"&&(s=.22),t.mode==="wallrunR"&&(s=-.22);const f=t.vel[0];s+=y(-f*.02,-.12,.12),i.current+=(s-i.current)*y(c*8,0,1),e.rotation.z=i.current,o.current+=c*(1+d*.3);const j=Math.sin(o.current*8)*y(d*.01,0,.04);e.position.y+=j}),null}function xe(){const[t,e]=u.useState("menu"),[r,i]=u.useState(null),[o,a]=u.useState(""),[c,l]=u.useState([]),[m,d]=u.useState("");return u.useEffect(()=>{const s=Y("http://localhost:3001",{reconnectionAttempts:1/0,reconnectionDelay:1e3});return i(s),s.on("connect",()=>d(s.id??"")),s.on("connect_error",f=>console.warn("socket connect_error",f&&(f.message||f))),s.on("lobby:update",f=>{a(f.roomCode),l(f.players),e("lobby")}),s.on("game:started",()=>e("game")),s.on("disconnect",()=>{e("menu"),l([]),a("")}),()=>{s.disconnect()}},[]),r?n.jsxs("div",{style:{width:"100%",height:"100vh"},children:[t==="menu"&&n.jsx(G,{socket:r}),t==="lobby"&&n.jsx(W,{socket:r,roomCode:o,players:c,selfId:m}),t==="game"&&n.jsx(fe,{socket:r,selfId:m})]}):n.jsx("div",{style:{padding:16},children:"Connecting…"})}N.createRoot(document.getElementById("root")).render(n.jsx(B.StrictMode,{children:n.jsx(xe,{})}));
