var Pe=Object.defineProperty;var Ee=(e,t,s)=>t in e?Pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var W=(e,t,s)=>Ee(e,typeof t!="symbol"?t+"":t,s);import{r as c,j as n,b as Le,d as Ae}from"./vendor_react-DAfT3zq5.js";import{l as ke}from"./vendor-C8VZyxSH.js";import{T as J,R as K,M as q,a as Ie,B as Ye,C as Ce,u as Te,b as Oe}from"./vendor_three-DveAjyFm.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function s(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=s(r);fetch(r.href,a)}})();function Fe({socket:e}){const[t,s]=c.useState("Runner"),[o,r]=c.useState("");function a(){e.emit("room:create",{name:t})}function u(){o&&e.emit("room:join",{code:o.toUpperCase(),name:t})}return n.jsx("div",{style:{display:"grid",placeItems:"center",height:"100%"},children:n.jsxs("div",{className:"panel",children:[n.jsx("h1",{style:{marginTop:0},children:"Parkour Tag"}),n.jsx("label",{style:{display:"block",marginBottom:8},children:"Display name"}),n.jsx("input",{value:t,onChange:d=>s(d.target.value),placeholder:"Your name",style:{width:"100%",marginBottom:12}}),n.jsxs("div",{style:{display:"flex",gap:8},children:[n.jsx("button",{onClick:a,children:"Host"}),n.jsx("input",{value:o,onChange:d=>r(d.target.value),placeholder:"Room code",style:{flex:1}}),n.jsx("button",{onClick:u,children:"Join"})]}),n.jsx("p",{style:{opacity:.85,marginTop:12},children:"Host creates a room. Others enter the code to join."})]})})}function Be({socket:e,roomCode:t,players:s,selfId:o}){const r=s.find(p=>p.id===o),a=r==null?void 0:r.host;function u(){e.emit("lobby:ready",{ready:!(r!=null&&r.ready)})}function d(){e.emit("game:start")}return n.jsxs("div",{style:{padding:24},children:[n.jsxs("h2",{children:["Room ",t]}),n.jsxs("div",{style:{display:"flex",gap:24,alignItems:"flex-start"},children:[n.jsxs("div",{children:[n.jsx("h3",{children:"Players"}),n.jsx("ul",{children:s.map(p=>n.jsxs("li",{children:[p.name," ",p.host?"(host)":""," ",p.ready?"✅":"⏳"," ",p.id===o?"← you":""]},p.id))})]}),n.jsxs("div",{style:{display:"flex",gap:12},children:[n.jsx("button",{onClick:u,children:r!=null&&r.ready?"Unready":"Ready"}),a&&n.jsx("button",{onClick:d,children:"Start"})]})]}),n.jsx("p",{style:{marginTop:16},children:"All players ready up. Host can start."}),n.jsx("p",{style:{opacity:.8},children:"Map voting will appear during intermission."})]})}function Ge(e){const t=c.useRef({forward:!1,back:!1,left:!1,right:!1,jump:!1,sprint:!1,crouch:!1,yaw:0,pitch:0}),s=.0025,o=Math.PI/2*.95;return c.useEffect(()=>{const r=(m,l)=>{if(!m.repeat){switch(m.code){case"KeyW":case"ArrowUp":t.current.forward=l;break;case"KeyS":case"ArrowDown":t.current.back=l;break;case"KeyA":case"ArrowLeft":t.current.left=l;break;case"KeyD":case"ArrowRight":t.current.right=l;break;case"Space":t.current.jump=l;break;case"ShiftLeft":case"ShiftRight":t.current.sprint=l;break;case"ControlLeft":case"ControlRight":t.current.crouch=l;break;default:return}e.emit("input",{...t.current})}},a=m=>{document.pointerLockElement===document.body&&(t.current.yaw-=m.movementX*s,t.current.pitch-=m.movementY*s,t.current.pitch>o&&(t.current.pitch=o),t.current.pitch<-o&&(t.current.pitch=-o),e.emit("input",{...t.current}))},u=()=>{var m;if(!document.pointerLockElement){const l=document.body;(m=l.requestPointerLock)==null||m.call(l)}},d=m=>r(m,!0),p=m=>r(m,!1);return window.addEventListener("keydown",d),window.addEventListener("keyup",p),window.addEventListener("mousemove",a),window.addEventListener("click",u),()=>{window.removeEventListener("keydown",d),window.removeEventListener("keyup",p),window.removeEventListener("mousemove",a),window.removeEventListener("click",u)}},[e]),t}const Q="ParkourYard",Z=[{min:[-30,-.5,-30],max:[30,0,30]},{min:[-10,1.5,-10],max:[-3,2,4]},{min:[3,1.2,-6],max:[12,1.9,6]},{min:[-14,3,8],max:[-2,3.5,20]},{min:[6,3.2,10],max:[16,3.8,22]},{min:[-20,0,-18],max:[-18,6,18]},{min:[18,0,-18],max:[20,6,18]},{min:[-2,.8,-2],max:[2,1.6,2]},{min:[-6,1.4,6],max:[-3,2.4,9]},{min:[4,2,-12],max:[9,3,-8]},{min:[-15,.5,-5],max:[-11,1,5]},{min:[-15,1,-5],max:[-12,1.5,5]},{min:[-15,1.5,-5],max:[-13,2,5]},{min:[-25,.5,25],max:[-10,2.5,28]},{min:[10,.5,-28],max:[25,2.5,-25]}],ee=[[-8,2.2,0],[8,2.2,0],[0,2.2,-8],[0,2.2,8],[-12,2.6,12],[12,2.6,-12]],Ne={name:Q,aabbs:Z,spawnPoints:ee},He=Object.freeze(Object.defineProperty({__proto__:null,aabbs:Z,default:Ne,name:Q,spawnPoints:ee},Symbol.toStringTag,{value:"Module"})),te="Rooftops",ne=[{min:[-40,-.5,-40],max:[40,0,40]},{min:[-15,3,-10],max:[15,3.5,10]},{min:[-30,6,-5],max:[-10,6.5,5]},{min:[10,6.5,-8],max:[30,7,8]},{min:[-5,1.8,-20],max:[5,2.3,-8]},{min:[-22,9,-2],max:[-8,9.3,12]},{min:[8,9.5,-12],max:[24,9.9,2]},{min:[-40,.5,36],max:[40,1.5,38]},{min:[-38,.5,-38],max:[-20,1.5,-36]}],se=[[-12,3.8,-2],[12,3.8,2],[-24,6.8,0],[24,6.9,0],[-2,2.2,-14],[2,2.2,-14]],De={name:te,aabbs:ne,spawnPoints:se},We=Object.freeze(Object.defineProperty({__proto__:null,aabbs:ne,default:De,name:te,spawnPoints:se},Symbol.toStringTag,{value:"Module"})),re=["ParkourYard","Rooftops"],Ke={default:"ParkourYard",options:re},qe=Object.freeze(Object.defineProperty({__proto__:null,default:Ke,options:re},Symbol.toStringTag,{value:"Module"})),ze={default:"ParkourYard"},S={},z=Object.assign({"../../shared/maps/ParkourYard.json":He,"../../shared/maps/Rooftops.json":We,"../../shared/maps/index.json":qe});for(const e of Object.keys(z)){const t=e.split("/").pop().replace(".json","");S[t]=z[e]}const Ue=S[ze.default]||S[Object.keys(S)[0]];function Ve(){const e=new J,t=c.useMemo(()=>{const a=e.load("/assets/textures/floor_grid.png");return a.wrapS=a.wrapT=K,a.repeat.set(10,10),a},[]),s=c.useMemo(()=>{const a=e.load("/assets/textures/wall_noise.png");return a.wrapS=a.wrapT=K,a.repeat.set(4,4),a},[]),o=c.useMemo(()=>new q({map:t}),[t]),r=c.useMemo(()=>new q({map:s}),[s]);return n.jsx("group",{children:Ue.aabbs.map((a,u)=>{const d=[a.max[0]-a.min[0],a.max[1]-a.min[1],a.max[2]-a.min[2]],p=[(a.min[0]+a.max[0])/2,(a.min[1]+a.max[1])/2,(a.min[2]+a.max[2])/2],m=u===0?o:r;return n.jsxs("mesh",{position:p,castShadow:!0,receiveShadow:!0,children:[n.jsx("boxGeometry",{args:d}),n.jsx("primitive",{object:m,attach:"material"})]},u)})})}function Xe({scores:e,itId:t}){const s=Object.entries(e).sort((o,r)=>r[1]-o[1]);return n.jsxs("div",{style:{position:"fixed",top:12,right:12,background:"rgba(0,0,0,0.35)",padding:"8px 12px",borderRadius:8,minWidth:160},children:[n.jsx("div",{style:{opacity:.8,marginBottom:6},children:"Scoreboard"}),s.map(([o,r])=>n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:12},children:[n.jsxs("span",{children:[o===t?"IT":"P",":",o.slice(0,4)]}),n.jsx("span",{children:Math.round(r)})]},o))]})}function $e({results:e}){return e?n.jsx("div",{style:{position:"fixed",inset:0,display:"grid",placeItems:"center",background:"rgba(0,0,0,0.5)"},children:n.jsxs("div",{style:{background:"#0b1128",padding:24,borderRadius:12,width:360},children:[n.jsx("h3",{style:{marginTop:0},children:"Round Results"}),n.jsx("ol",{children:e.placement.map(t=>n.jsxs("li",{style:{display:"flex",justifyContent:"space-between"},children:[n.jsx("span",{children:t.name}),n.jsx("span",{children:t.score})]},t.id))}),n.jsx("p",{style:{opacity:.8},children:"Intermission. Next map loading soon."})]})}):null}function Je({socket:e,maps:t,current:s}){const o=c.useMemo(()=>t,[t]);return o!=null&&o.length?n.jsxs("div",{style:{position:"fixed",bottom:12,left:"50%",transform:"translateX(-50%)",background:"rgba(0,0,0,0.35)",padding:"10px 12px",borderRadius:10,display:"flex",gap:10},children:[n.jsx("span",{style:{opacity:.8,marginRight:6},children:"Vote next map:"}),o.map(r=>n.jsx("button",{onClick:()=>e.emit("vote:map",{name:r}),style:{padding:"8px 10px",borderRadius:8,border:"1px solid #30407a",background:r===s?"#1b2a5a":"#0d1430",color:"#fff"},children:r},r))]}):null}const Qe=70;function I(e,t,s){return e+(t-e)*s}function U(e,t,s){let o=t-e;for(;o>Math.PI;)o-=Math.PI*2;for(;o<-Math.PI;)o+=Math.PI*2;return e+o*s}class Ze{constructor(){W(this,"buf",[])}push(t){this.buf.push({t:performance.now(),snap:t}),this.buf.length>20&&this.buf.shift()}sample(){var m;if(this.buf.length<2)return((m=this.buf[this.buf.length-1])==null?void 0:m.snap)||null;const t=performance.now()-Qe;let s=0;for(;s+1<this.buf.length&&this.buf[s+1].t<t;)s++;const o=this.buf[s],r=this.buf[s+1]||o,a=Math.max(1,r.t-o.t),u=Math.min(1,Math.max(0,(t-o.t)/a));function d(l,f){return[I(l[0],f[0],u),I(l[1],f[1],u),I(l[2],f[2],u)]}const p=[];for(const l of o.snap.players){const f=r.snap.players.find(i=>i.id===l.id)||l;p.push({...l,pos:d(l.pos,f.pos),vel:d(l.vel,f.vel),yaw:U(l.yaw,f.yaw,u),pitch:U(l.pitch,f.pitch,u),mode:f.mode})}return{...r.snap,players:p}}}function et(e,t,s=1,o=220){e.style.setProperty(t,String(s));const r=performance.now();function a(){const u=performance.now()-r,d=Math.max(0,1-u/o);e.style.setProperty(t,String(d*s)),d>0&&requestAnimationFrame(a)}requestAnimationFrame(a)}const tt={jump:"/assets/sfx/jump.wav",slide:"/assets/sfx/slide.wav",wallrun:"/assets/sfx/wallrun.wav",walljump:"/assets/sfx/walljump.wav",mantle:"/assets/sfx/mantle.wav",land:"/assets/sfx/land.wav",tag:"/assets/sfx/tag.wav",countdown:"/assets/sfx/countdown.wav",round_start:"/assets/sfx/round_start.wav",round_end:"/assets/sfx/round_end.wav"},V=new Map;function nt(e,t=.6){const s=tt[e];if(!s)return;let o=V.get(s);o||(o=new Audio(s),V.set(s,o));const r=o.cloneNode(!0);r.volume=t,r.play().catch(()=>{})}function st({size:e=800}){const t=c.useMemo(()=>["#87ceeb","#87ceeb","#bfe9ff","#6aa7d8","#85c1ff","#85c1ff"],[]),s=c.useMemo(()=>t.map(o=>new Ie({color:o,side:Ye,depthWrite:!1})),[t]);return n.jsx("mesh",{material:s,children:n.jsx("boxGeometry",{args:[e,e,e]})})}const rt="/assets/face-CnBGMtiw.png",ot={HEIGHT:1.8,EYE_HEIGHT:1.62},X={PLAYER:ot};function at({socket:e,selfId:t}){const s=Ge(e),[o,r]=c.useState(null),[a,u]=c.useState(null),[d,p]=c.useState([]),[m,l]=c.useState(""),f=c.useRef(new Ze),[i,b]=c.useState(null);c.useEffect(()=>{const x=h=>{f.current.push(h),r(h)};return e.on("world:snapshot",x),e.on("round:results",h=>u(h)),e.on("lobby:update",h=>{h!=null&&h.maps&&p(h.maps),h!=null&&h.mapName&&l(h.mapName)}),e.on("sfx",h=>{const g=String(h.kind||"").toLowerCase(),R={jump:"jump",slide:"slide",wallrun:"wallrun",walljump:"walljump",mantle:"mantle",land:"land",tag:"tag",countdown:"countdown",round_start:"round_start",round_end:"round_end"}[g]||"jump";try{nt(R)}catch{}g==="jump"&&$("--jump",.7),g==="tag"&&$("--hit",1)}),()=>{e.off("world:snapshot",x),e.off("round:results"),e.off("lobby:update"),e.off("sfx")}},[e]),c.useEffect(()=>{let x=0;const h=()=>{const g=f.current.sample();g&&b(g),x=requestAnimationFrame(h)};return x=requestAnimationFrame(h),()=>cancelAnimationFrame(x)},[]);const w=c.useMemo(()=>i==null?void 0:i.players.find(x=>x.id===t),[i,t]);return n.jsxs(n.Fragment,{children:[n.jsxs(Ce,{camera:{position:[0,2,4],fov:80},shadows:!0,dpr:Math.min(typeof window<"u"&&window.devicePixelRatio||1,1.25),children:[n.jsx(st,{}),n.jsx("hemisphereLight",{args:["#e6f7ff","#44404a",.9]}),n.jsx("ambientLight",{intensity:.5}),n.jsx("directionalLight",{position:[10,14,6],intensity:1.2,castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,"shadow-bias":-5e-4}),n.jsx(Ve,{}),i==null?void 0:i.players.map(x=>n.jsx(it,{p:x,isSelf:x.id===t,isIt:(i==null?void 0:i.itId)===x.id},x.id)),n.jsx(ct,{me:w||null,inputRef:s})]}),n.jsxs("div",{className:"hud",style:{position:"fixed",top:12,left:12},children:[n.jsxs("div",{children:["Players: ",(i==null?void 0:i.players.length)??0]}),n.jsxs("div",{children:["Status: ",i!=null&&i.intermission?"Intermission":(i==null?void 0:i.itId)===t?"You are IT!":i!=null&&i.itId?"Run!":""]}),n.jsxs("div",{children:["Time: ",Math.ceil((i==null?void 0:i.roundTime)??0),"s"]}),n.jsxs("div",{children:["Map: ",(i==null?void 0:i.mapName)||m]}),n.jsx("div",{style:{marginTop:8},children:"Click to lock mouse"})]}),i&&n.jsx(Xe,{scores:i.scores,itId:i.itId}),n.jsx($e,{results:a}),(i==null?void 0:i.intermission)&&n.jsx(Je,{socket:e,maps:d,current:i.mapName})]})}function $(e,t){const s=document.getElementById("fx");s&&et(s,e,t,200)}function it({p:e,isSelf:t,isIt:s}){const o=c.useMemo(()=>new J().load(rt),[]),r=X.PLAYER.HEIGHT,a=X.PLAYER.EYE_HEIGHT,u=r/2,d=a-u;return n.jsx("group",{position:e.pos,rotation:[0,e.yaw,0],children:!t&&n.jsxs(n.Fragment,{children:[n.jsxs("mesh",{position:[0,u,0],castShadow:!1,receiveShadow:!1,children:[n.jsx("boxGeometry",{args:[.7,r,.7]}),n.jsx("meshStandardMaterial",{color:s?"#ff5d5d":"#f0b46d"})]}),n.jsxs("mesh",{position:[0,d,-.36],rotation:[0,Math.PI,0],children:[n.jsx("planeGeometry",{args:[.7,.7]}),n.jsx("meshBasicMaterial",{map:o,transparent:!0})]})]})})}function ct({me:e,inputRef:t}){const{camera:s}=Te(),o=c.useRef(0),r=c.useRef(0),a=c.useRef(80),u=c.useRef(0),d=c.useRef(0),p=c.useRef(0),m=c.useRef(0),l=c.useRef(0),f=c.useRef(0),i=c.useRef(null),b=c.useRef(!1),w=c.useRef(0),x=1.62,h=80,g=96,Y=.14,R=1.4,oe=.035,ae=.009,ie=.004,C=7.5,ce=14,T=.18,le=-.08,ue=-.065,de=-.1,O=10;return c.useEffect(()=>{var _,y;e&&(o.current=((_=t.current)==null?void 0:_.yaw)??e.yaw,r.current=((y=t.current)==null?void 0:y.pitch)??e.pitch,i.current=e.mode,b.current=!!e.onGround)},[e]),Oe((_,y)=>{var H,D;if(!e)return;const P=[e.pos[0],e.pos[1]+x,e.pos[2]];s.position.x+=(P[0]-s.position.x)*Math.min(1,y*10),s.position.y+=(P[1]-s.position.y)*Math.min(1,y*12),s.position.z+=(P[2]-s.position.z)*Math.min(1,y*10);const me=((H=t.current)==null?void 0:H.yaw)??e.yaw,fe=((D=t.current)==null?void 0:D.pitch)??e.pitch,F=Math.min(1,y*12);o.current+=(me-o.current)*F,r.current+=(fe-r.current)*F;const v=Math.hypot(e.vel[0],e.vel[2]),pe=Math.max(h,Math.min(g,h+v*Y));a.current+=(pe-a.current)*Math.min(1,y*2.5);const he=!!e.onGround||e.mode==="ground"||e.mode==="slide",xe=e.mode==="wallrunL"||e.mode==="wallrunR"||e.mode==="mantle",ye=he&&!xe,we=v>.2,E=ye&&we?Math.max(.6,Math.min(1.4,v/C)):0,ge=R*Math.max(.9,Math.min(1.3,v/C));f.current+=y*ge*Math.PI*2;const B=Math.sin(f.current),je=Math.sin(f.current*2),be=-(oe*E)*B,ve=-(ae*E)*B,Me=ie*E*je,L=Math.min(1,y*ce);d.current+=(be-d.current)*L,p.current+=(ve-p.current)*L,m.current+=(Me-m.current)*L;const j=t.current,Se=-.04*((j!=null&&j.left?-1:0)+(j!=null&&j.right?1:0));let A=0;e.mode==="wallrunL"&&(A=T),e.mode==="wallrunR"&&(A=-T);const Re=Se+A;u.current+=(Re-u.current)*Math.min(1,y*8);let G=0;e.mode==="slide"&&(G+=le);const M=i.current,_e=b.current,N=!!e.onGround;if(((M==="air"||M==="wallrunL"||M==="wallrunR"||M==="mantle")&&e.mode==="ground"||!_e&&N)&&(l.current=ue,w.current=de),i.current=e.mode,b.current=N,l.current!==0){const k=Math.sign(-l.current)*Math.min(Math.abs(l.current),O*y);l.current+=k,Math.abs(l.current)<.001&&(l.current=0)}if(w.current!==0){const k=(0-w.current)*Math.min(1,y*O);w.current+=k,Math.abs(w.current)<1e-4&&(w.current=0)}s.rotation.order="YXZ",s.rotation.y=o.current+p.current,s.rotation.x=r.current+(G+l.current)+m.current,s.rotation.z=u.current+d.current,s.position.y+=w.current,s.fov=a.current,s.updateProjectionMatrix()}),null}function lt(){const[e,t]=c.useState("menu"),[s,o]=c.useState(null),[r,a]=c.useState(""),[u,d]=c.useState([]),[p,m]=c.useState("");return c.useEffect(()=>{const f=ke("http://localhost:3001",{reconnectionAttempts:1/0,reconnectionDelay:1e3});return o(f),f.on("connect",()=>m(f.id??"")),f.on("connect_error",i=>console.warn("socket connect_error",i&&(i.message||i))),f.on("lobby:update",i=>{a(i.roomCode),d(i.players),t("lobby")}),f.on("game:started",()=>t("game")),f.on("disconnect",()=>{t("menu"),d([]),a("")}),()=>{f.disconnect()}},[]),s?n.jsxs("div",{style:{width:"100%",height:"100vh"},children:[e==="menu"&&n.jsx(Fe,{socket:s}),e==="lobby"&&n.jsx(Be,{socket:s,roomCode:r,players:u,selfId:p}),e==="game"&&n.jsx(at,{socket:s,selfId:p})]}):n.jsx("div",{style:{padding:16},children:"Connecting…"})}Le.createRoot(document.getElementById("root")).render(n.jsx(Ae.StrictMode,{children:n.jsx(lt,{})}));
